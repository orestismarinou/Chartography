<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Thessalia Cartography â€“ Interactive Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<style>
  body { margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  #styleSelector { position: absolute; top: 10px; left: 10px; z-index: 6; background: white; padding: 6px; border-radius: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.25); }
  #controls { position: absolute; top: 60px; left: 10px; z-index: 6; background: white; padding: 10px; font-size: 13px; border-radius: 6px; width: 300px; max-height: 80vh; overflow-y: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
  .layer-controls { margin-top:6px; padding:8px; background:#fafafa; border-radius:4px; display:none; }
  .layer-controls label { display:block; font-size:12px; margin-top:6px; }
  .layer-controls input[type="range"], .layer-controls select { width:100%; margin-top:4px; }
  #legend { position: absolute; top: 10px; right: 10px; z-index: 6; background: white; padding: 18px; font-size: 13px; border-radius: 6px; max-width: 360px; max-height: 85vh; box-shadow: 0 2px 6px rgba(0,0,0,0.25); display: none; resize: both; overflow: auto; min-width: 200px; min-height: 100px; }
  .legend-header { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #333; }
  .legend-map-title { font-size: 15px; font-weight: 700; color: #000; margin-bottom: 10px; line-height: 1.4; text-align: center; }
  .legend-author { font-size: 10px; color: #555; line-height: 1.4; text-align: left; }
  .legend-author strong { font-weight: 700; }
  .legend-row { display:flex; align-items:center; margin-bottom:8px; }
  .legend-color { width:20px; height:20px; margin-right:8px; border-radius:3px; flex:none; }
  .legend-line { width:40px; height:14px; margin-right:8px; flex:none; }
  .legend-title { font-weight:700; margin-bottom:8px; display:block; }
  .control-value { font-weight:700; margin-left:6px; color:#333; }
  hr { border: none; border-top: 1px solid #eee; margin:8px 0; }
</style>
</head>
<body>

<div id="styleSelector">
  <select id="basemapSelect">
    <option value="https://basemaps.cartocdn.com/gl/positron-gl-style/style.json">Light</option>
    <option value="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json" selected>Dark</option>
  </select>
</div>

<div id="controls">
  <strong>Layers</strong><br><br>
  <input type="checkbox" id="popdensToggle"> <strong>Population Density (Choropleth)</strong><br>
  <div class="layer-controls" id="popdensControls">
    <label>Method: <select id="classificationMethod"><option value="equal">Equal interval</option><option value="quantile" selected>Quantiles</option><option value="natural">Natural breaks</option><option value="custom">Custom</option></select></label>
    <label id="numClassesLabel">Classes: <select id="numClasses"><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option></select></label>
    <label>Opacity: <span id="popdensOpacityLabel">60%</span><input type="range" id="popdensOpacity" min="0" max="100" value="60"></label>
  </div>
  <hr>
  <input type="checkbox" id="denscoverToggle"> <strong>Density (Dasymmetric)</strong><br>
  <div class="layer-controls" id="denscoverControls">
    <label>Method: <select id="denscoverClassificationMethod"><option value="equal">Equal interval</option><option value="quantile" selected>Quantiles</option><option value="natural">Natural breaks</option><option value="custom">Custom</option></select></label>
    <label id="denscoverNumClassesLabel">Classes: <select id="denscoverNumClasses"><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option><option value="6">6</option><option value="7">7</option></select></label>
    <label>Opacity: <span id="denscoverOpacityLabel">60%</span><input type="range" id="denscoverOpacity" min="0" max="100" value="60"></label>
  </div>
  <hr>
  <input type="checkbox" id="poipopToggle"> <strong>Population (Symbols)</strong><br>
  <div class="layer-controls" id="poipopControls">
    <label>Max Radius: <span id="maxRadiusLabel">100</span><input type="range" id="maxRadius" min="20" max="200" value="100"></label>
    <label>Opacity: <span id="poipopOpacityLabel">25%</span><input type="range" id="poipopOpacity" min="0" max="100" value="25"></label>
  </div>
  <hr>
  <input type="checkbox" id="contoursToggle"> <strong>Potentials (Isopleths)</strong><br>
  <div class="layer-controls" id="contoursControls">
    <label>Opacity: <span id="contoursOpacityLabel">80%</span><input type="range" id="contoursOpacity" min="0" max="100" value="80"></label>
  </div>
  <hr>
  <input type="checkbox" id="dotsToggle"> <strong>Population (Dots)</strong><br>
  <div class="layer-controls" id="dotsControls">
    <label>Size: <span id="dotSizeLabel">1.9</span><input type="range" id="dotSize" min="0.5" max="6" step="0.1" value="1.9"></label>
    <label>Opacity: <span id="dotsOpacityLabel">100%</span><input type="range" id="dotsOpacity" min="0" max="100" value="100"></label>
  </div>
  <hr>
  <input type="checkbox" id="boundariesToggle"> <strong>Boundaries</strong><br>
  <div class="layer-controls" id="boundariesControls">
    <label>Opacity: <span id="boundariesOpacityLabel">100%</span><input type="range" id="boundariesOpacity" min="0" max="100" value="100"></label>
  </div>
</div>

<div id="legend"></div>
<div id="map"></div>

<script>
// 1. MAP INITIALIZATION
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [22.45, 39.55], zoom: 8.5 
});

// 2. DATA CONFIGURATION
const layerDefinitions = {
  popdens: {
    sourceId: 'popdens-src', layerId: 'popdens-layer',
    url: 'dimoi_popdens.geojson',
    dataField: 'POPDENS'
  },
  denscover: {
    sourceId: 'denscover-src', layerId: 'denscover-layer',
    url: 'dimoi_popdens_cover.geojson',
    dataField: 'DENS_COVER'
  },
  poipop: {
    sourceId: 'poipop-src', layerId: 'poipop-layer',
    url: 'dimoipoi_pop.geojson',
    dataField: 'POPMUN', maxValueApprox: 150000 
  },
  contours: {
    sourceId: 'contours-src', layerId: 'contours-layer',
    url: 'kampules_WGS84.geojson'
  },
  dots: {
    sourceId: 'dots-src', layerId: 'dots-layer',
    url: 'koukides_500_WGS84.geojson'
  },
  boundaries: {
    sourceId: 'boundaries-src', layerId: 'boundaries-layer',
    url: 'dimoi_oria_WGS84.geojson'
  }
};

let popdensData = null;
let denscoverData = null;
const enabledLayers = { popdens: false, denscover: false, poipop: false, contours: false, dots: false, boundaries: false };

const colorSchemes = { 5: ['#ffcccc', '#ff9999', '#ff6666', '#cc0000', '#990000'] }; 
const denscoverColorSchemes = { 5: ['#ffcccc', '#ff9999', '#ff6666', '#cc0000', '#990000'] };
const customBreaks = [30, 75, 150, 300, 600];
const customColors = ['#ffcccc', '#ff9999', '#ff6666', '#cc0000', '#990000', '#660000'];
const denscoverCustomBreaks = [500, 1500, 3500, 6000, 8500];
const denscoverCustomColors = ['#ffcccc', '#ff9999', '#ff6666', '#cc0000', '#990000', '#660000'];

// HELPER FUNCTIONS
function getBreaks(values, n, method) {
  const sorted = values.filter(v => !isNaN(v)).sort((a,b)=>a-b);
  if (!sorted.length) return [];
  if (method === 'equal') {
    const min=sorted[0], max=sorted[sorted.length-1], step=(max-min)/n, breaks=[];
    for(let i=1;i<n;i++) breaks.push(min+step*i); return breaks.map(b=>Number(b.toFixed(2)));
  }
  if (method === 'quantile') {
    const breaks=[]; for(let i=1;i<n;i++) breaks.push(sorted[Math.floor(sorted.length*i/n)]); return breaks.map(b=>Number(b.toFixed(2)));
  }
  return sorted.length ? [sorted[sorted.length-1]] : []; // Fallback
}

function createStepExpr(breaks, colors, field) {
  const expr = ['step', ['get', field], colors[0]];
  for (let i=0; i<breaks.length; i++) { expr.push(breaks[i]); expr.push(colors[i+1]||colors[colors.length-1]); }
  return expr;
}

function ensureSource(id, data) { if(!map.getSource(id)) map.addSource(id, {type:'geojson', data:data}); }

// LAYER LOADING
function loadPopDens() {
  fetch(layerDefinitions.popdens.url).then(r=>r.json()).then(gj=>{
    popdensData=gj; updatePopDens();
  }).catch(e=>console.error(e));
}
function updatePopDens() {
  if(!popdensData) return;
  const method = document.getElementById('classificationMethod').value;
  let breaks, colors = colorSchemes[5];
  if(method==='custom') { breaks=customBreaks; colors=customColors; }
  else { breaks = getBreaks(popdensData.features.map(f=>f.properties.POPDENS), 5, method); }
  
  ensureSource(layerDefinitions.popdens.sourceId, popdensData);
  const expr = createStepExpr(breaks, colors, 'POPDENS');
  
  if(map.getLayer('popdens-layer')) map.setPaintProperty('popdens-layer', 'fill-color', expr);
  else map.addLayer({ id:'popdens-layer', type:'fill', source:'popdens-src', paint:{ 'fill-color':expr, 'fill-opacity':0.6 }});
  
  layerDefinitions.popdens.breaks = breaks; layerDefinitions.popdens.colors = colors;
  enabledLayers.popdens = true; document.getElementById('popdensControls').style.display='block'; updateLegend();
}

function loadDensCover() {
  fetch(layerDefinitions.denscover.url).then(r=>r.json()).then(gj=>{
    denscoverData=gj; updateDensCover();
  }).catch(e=>console.error(e));
}
function updateDensCover() {
  if(!denscoverData) return;
  const method = document.getElementById('denscoverClassificationMethod').value;
  let breaks, colors = denscoverColorSchemes[5];
  if(method==='custom') { breaks=denscoverCustomBreaks; colors=denscoverCustomColors; }
  else { breaks = getBreaks(denscoverData.features.map(f=>f.properties.DENS_COVER), 5, method); }
  
  ensureSource(layerDefinitions.denscover.sourceId, denscoverData);
  const expr = createStepExpr(breaks, colors, 'DENS_COVER');
  
  if(map.getLayer('denscover-layer')) map.setPaintProperty('denscover-layer', 'fill-color', expr);
  else map.addLayer({ id:'denscover-layer', type:'fill', source:'denscover-src', paint:{ 'fill-color':expr, 'fill-opacity':0.6 }});
  
  layerDefinitions.denscover.breaks = breaks; layerDefinitions.denscover.colors = colors;
  enabledLayers.denscover = true; document.getElementById('denscoverControls').style.display='block'; updateLegend();
}

function loadPoiPop() {
  fetch(layerDefinitions.poipop.url).then(r=>r.json()).then(gj=>{
    gj.features.sort((a,b)=> (b.properties.POPMUN||0)-(a.properties.POPMUN||0));
    ensureSource('poipop-src', gj);
    const radiusExpr = ['*', ['^', ['/', ['get', 'POPMUN'], 150000], 0.57], parseInt(document.getElementById('maxRadius').value)];
    if(!map.getLayer('poipop-layer')) map.addLayer({id:'poipop-layer', type:'circle', source:'poipop-src', paint:{'circle-color':'rgba(255,0,0,0.25)', 'circle-stroke-color':'red', 'circle-stroke-width':1, 'circle-radius':radiusExpr}});
    else map.setPaintProperty('poipop-layer', 'circle-radius', radiusExpr);
    enabledLayers.poipop=true; document.getElementById('poipopControls').style.display='block'; updateLegend();
  });
}

function loadContours() {
  ensureSource('contours-src', layerDefinitions.contours.url);
  if(!map.getLayer('contours-layer')) map.addLayer({id:'contours-layer', type:'line', source:'contours-src', paint:{'line-color':'#8B0000', 'line-width':2}});
  enabledLayers.contours=true; document.getElementById('contoursControls').style.display='block'; updateLegend();
}

function loadDots() {
  ensureSource('dots-src', layerDefinitions.dots.url);
  if(!map.getLayer('dots-layer')) map.addLayer({id:'dots-layer', type:'circle', source:'dots-src', paint:{'circle-color':'red', 'circle-radius':1.9}});
  enabledLayers.dots=true; document.getElementById('dotsControls').style.display='block'; updateLegend();
}

function loadBoundaries() {
  ensureSource('boundaries-src', layerDefinitions.boundaries.url);
  if(!map.getLayer('boundaries-layer')) map.addLayer({id:'boundaries-layer', type:'line', source:'boundaries-src', paint:{'line-color':'#bbbbbb', 'line-width':1}});
  enabledLayers.boundaries=true; document.getElementById('boundariesControls').style.display='block'; updateLegend();
}

// EVENTS
document.getElementById('popdensToggle').addEventListener('change', e=>{ if(e.target.checked) loadPopDens(); else { map.removeLayer('popdens-layer'); enabledLayers.popdens=false; document.getElementById('popdensControls').style.display='none'; updateLegend();} });
document.getElementById('denscoverToggle').addEventListener('change', e=>{ if(e.target.checked) loadDensCover(); else { map.removeLayer('denscover-layer'); enabledLayers.denscover=false; document.getElementById('denscoverControls').style.display='none'; updateLegend();} });
document.getElementById('poipopToggle').addEventListener('change', e=>{ if(e.target.checked) loadPoiPop(); else { map.removeLayer('poipop-layer'); enabledLayers.poipop=false; document.getElementById('poipopControls').style.display='none'; updateLegend();} });
document.getElementById('contoursToggle').addEventListener('change', e=>{ if(e.target.checked) loadContours(); else { map.removeLayer('contours-layer'); enabledLayers.contours=false; document.getElementById('contoursControls').style.display='none'; updateLegend();} });
document.getElementById('dotsToggle').addEventListener('change', e=>{ if(e.target.checked) loadDots(); else { map.removeLayer('dots-layer'); enabledLayers.dots=false; document.getElementById('dotsControls').style.display='none'; updateLegend();} });
document.getElementById('boundariesToggle').addEventListener('change', e=>{ if(e.target.checked) loadBoundaries(); else { map.removeLayer('boundaries-layer'); enabledLayers.boundaries=false; document.getElementById('boundariesControls').style.display='none'; updateLegend();} });

// LEGEND
function updateLegend() {
  const legend = document.getElementById('legend');
  let html = `<div class="legend-header"><div class="legend-map-title">THESSALIA MAP</div><div class="legend-author">Produced by: Orestis Marinou<br>Student ID: rs19004</div></div>`;
  
  if(enabledLayers.popdens && layerDefinitions.popdens.breaks) {
    html += `<b>Population Density</b><br>`;
    const b = layerDefinitions.popdens.breaks, c = layerDefinitions.popdens.colors;
    for(let i=0; i<b.length; i++) html += `<div class="legend-row"><div class="legend-color" style="background:${c[i]}"></div> < ${b[i]}</div>`;
    html += `<hr>`;
  }
  if(enabledLayers.poipop) html += `<b>Population</b><br>Circles proportional to pop.<hr>`;
  if(enabledLayers.contours) html += `<b>Potentials</b><br>Red lines<hr>`;
  if(enabledLayers.dots) html += `<b>Density</b><br>Red dots<hr>`;
  
  legend.innerHTML = html;
  legend.style.display = Object.values(enabledLayers).some(Boolean) ? 'block' : 'none';
}

// INITIAL CALLS
map.on('load', () => console.log('Map loaded'));
</script>
</body>
</html>
